/*
 * D2JS
 * Copyright (C) SatisKia. All rights reserved.
 */
(function(n,t){function o(n,t,i,u,f,e,o,s,h){if(this._p=n,this._index=t,this._tex_index=i,this._mat=u,this._trans=f>=0?f:n.transparency(),this._distance=0,e){var c=o-r.positionX(),l=s-r.positionY(),a=h-r.positionZ();this._distance=r.distance(c,l,a)}}function g(n,i){this._proj_mat=n;this._sprite_view_flag=i==t?!0:i;this._draw=[]}function kt(){var n=e.createElement(s),t=n.getContext(h);return t!=null}function dt(n){if(n==t){var i=e.createElement(s);n=i.getContext(h)}return n.getExtension(et)!=null}function gt(n){if(n==t){var i=e.createElement(s);n=i.getContext(h)}return n.getExtension(ot)!=null}function ni(n,f,o){var s,c;f==t&&(f="");o==t&&(o=!1);removeMouseEvent();s=setCanvas(e.getElementById(n));i=o?s.getContext(h,{stencil:!0}):s.getContext(h);initLock();f.length>0&&(u=s,s=setCanvas(e.getElementById(f)),c=setContext(s.getContext(a)),s.width=u.width,s.height=u.height,c.textAlign=st,c.textBaseline=ht,setGraphics(new _Graphics));addMouseEvent();r=new b;init3D(i,r)?(u!=null&&init2D(getGraphics()),setRepaintFunc(nt)):killTimer()}function v(){return u==null?getCurrent():u}function ti(){return i}function ii(n,t){v().width=n;v().height=t}function tt(n,r,u){var f=i.createShader(n);return(i.shaderSource(f,r),i.compileShader(f),!i.getShaderParameter(f,i.COMPILE_STATUS))?(u!=t&&u(0,i.getShaderInfoLog(f)),i.deleteShader(f),null):f}function y(n,r,u){var e=tt(i.VERTEX_SHADER,n,u),o=tt(i.FRAGMENT_SHADER,r,u),f=i.createProgram();return(i.attachShader(f,e),i.attachShader(f,o),i.linkProgram(f),!i.getProgramParameter(f,i.LINK_STATUS))?(u!=t&&u(1,i.getProgramInfoLog(f)),null):f}function p(n,t,r){this._glp=new l;this._glp.setType(0);this._glp.setDepth(t);this._id=n;this._lighting=r;this._material_num=0;this._material_texture=null;this._material_diffuse=null;this._material_ambient=null;this._material_emission=null;this._material_specular=null;this._material_shininess=null;this._object_num=0;this._coord=null;this._normal=null;this._color=null;this._map=null;this._radius=0;this._strip_num=0;this._strip_material=null;this._strip_coord=null;this._strip_normal=null;this._strip_color=null;this._strip_map=null;this._strip_len=null;this._strip=null;this._strip_type=2;this._strip_tx=null;this._strip_ty=null;this._strip_tz=null;this._strip_or=null;this._strip_ox=null;this._strip_oy=null;this._strip_oz=null;this._texture_env_mode_flag=!1;this._texture_env_mode=0;this._position_buffer=i.createBuffer();this._normal_buffer=i.createBuffer();this._color_buffer=i.createBuffer();this._texture_coord_buffer=i.createBuffer();this._strip_buffer=i.createBuffer()}function c(n){this._data=n;this._cur=0}function ri(n,t,i,u,f,e){var h,ct,lt,at,vt,yt,pt,bt,ot,a,w,st,b,v,tt;h=n instanceof c?n:new c(n);for(var it=new p(i,u,f),o,ht,rt,ut,ft,et,y=h.get(),dt=new Array(y),k=new Array(y*4),d=new Array(y*4),g=new Array(y*4),nt=new Array(y*4),gt=new Array(y),s=0;s<y;s++)dt[s]=h.get(),k[s*4]=h.get(),k[s*4+1]=k[s*4],k[s*4+2]=k[s*4],k[s*4+3]=1,d[s*4]=h.get(),d[s*4+1]=d[s*4],d[s*4+2]=d[s*4],d[s*4+3]=1,g[s*4]=h.get(),g[s*4+1]=g[s*4],g[s*4+2]=g[s*4],g[s*4+3]=1,nt[s*4]=h.get(),nt[s*4+1]=nt[s*4],nt[s*4+2]=nt[s*4],nt[s*4+3]=1,gt[s]=h.get()*128/100;it.setMaterial(y,dt,k,d,g,nt,gt);var ai=h.get()*t,vi=h.get()*t,yi=h.get()*t,pi=h.get(),wi=h.get(),bi=h.get(),ki=h.get();if(r.setIdentity(),r.translate(ai,vi,yi),r.rotate(wi,bi,ki,pi),ot=0,a=h.get(),rt=null,w=null,a>0)for(rt=new Array(a),w=new Array(a),o=0;o<a;o++)if(rt[o]=h.get(),rt[o]<=0)w[o]=null;else for(w[o]=new Array(rt[o]*3),s=0;s<rt[o];s++)ct=h.get()*t,lt=h.get()*t,at=h.get()*t,r.transVector(ct,lt,at),vt=r.transX(),yt=r.transY(),pt=r.transZ(),bt=vt*vt+yt*yt+pt*pt,bt>ot&&(ot=bt),w[o][s*3]=vt,w[o][s*3+1]=yt,w[o][s*3+2]=pt;if(ot=Math.sqrt(ot),st=h.get(),ut=null,b=null,st>0)for(ut=new Array(a),b=new Array(a),o=0;o<a;o++)if(ut[o]=h.get(),ut[o]<=0)b[o]=null;else for(b[o]=new Array(ut[o]*3),s=0;s<ut[o];s++)ct=h.get(),lt=h.get(),at=h.get(),r.transVector(ct,lt,at),b[o][s*3]=r.transX(),b[o][s*3+1]=r.transY(),b[o][s*3+2]=r.transZ();if(st=h.get(),ft=null,v=null,st>0)for(ft=new Array(a),v=new Array(a),o=0;o<a;o++)if(ft[o]=h.get(),ft[o]<=0)v[o]=null;else for(v[o]=new Array(ft[o]*4),s=0;s<ft[o];s++)v[o][s*4]=h.get(),v[o][s*4+1]=h.get(),v[o][s*4+2]=h.get(),v[o][s*4+3]=1;if(st=h.get(),et=null,tt=null,st>0)for(et=new Array(a),tt=new Array(a),o=0;o<a;o++)if(et[o]=h.get(),et[o]<=0)tt[o]=null;else for(tt[o]=new Array(et[o]*2),s=0;s<et[o];s++)tt[o][s*2]=h.get(),tt[o][s*2+1]=h.get();it.setObject(a,w,b,v,tt,ot);var l=h.get(),ni=new Array(l),ti=new Array(l),ii=new Array(l),ri=new Array(l),ui=new Array(l),fi=new Array(l),ei=new Array(l),oi=new Array(l),si=new Array(l),hi=new Array(l),ci=new Array(l),li=new Array(l),wt=new Array(l),kt=new Array(l);for(o=0;o<l;o++)for(ni[o]=h.get()*t,ti[o]=h.get()*t,ii[o]=h.get()*t,ri[o]=h.get(),ui[o]=h.get(),fi[o]=h.get(),ei[o]=h.get(),oi[o]=h.get(),si[o]=h.get(),hi[o]=h.get(),ci[o]=h.get(),li[o]=h.get(),wt[o]=h.get(),kt[o]=new Array(wt[o]),ht=0;ht<wt[o];ht++)kt[o][ht]=h.get();return it.setStrip(l,oi,si,hi,ci,li,wt,kt,e),it.setStripTranslate(ni,ti,ii),it.setStripRotate(ri,ui,fi,ei),it}function l(){this._type=0;this._depth=!1;this._trans=1}function f(n,r,u){if(this._program=typeof glShaderError!="undefined"?y(n,r,glShaderError):y(n,r),u!=t&&u==!0){var s,h,o,a,v,f,c,p,w,l,e;for(this.vars=[],h=0;h<2;h++)for(o=""+(h==0?n:r),s=0;s<2;s++)for(p=s==0?pt:wt;;)if((w=o.indexOf(p))>=0)if(a=o.substring(w),(l=a.indexOf(bt))>=0){if(e="",v=a.substring(0,l),f=v.split("\t"),f.length>0?(c=f[f.length-1].split(d),e=c.length>0?c[c.length-1]:f[f.length-1]):(f=v.split(d),f.length>0&&(e=f[f.length-1])),e.length>0&&(this.vars[e]=s==0?i.getAttribLocation(this._program,e):i.getUniformLocation(this._program,e)),l+1>=o.length)break;o=o.substring(l+1)}else break;else break}}function it(n,t){this._glp=new l;this._glp.setType(1);this._glp.setDepth(t);this._id=n;this._coord=new Array(12);this._map=new Array(8);this._uv=new Array(8);this._uv_f=!0;this._coord_buffer=i.createBuffer();this._uv_buffer=i.createBuffer();this._coord[0]=-1;this._coord[1]=-1;this._coord[2]=0;this._coord[3]=1;this._coord[4]=-1;this._coord[5]=0;this._coord[6]=-1;this._coord[7]=1;this._coord[8]=0;this._coord[9]=1;this._coord[10]=1;this._coord[11]=0;this._uv[0]=0;this._uv[1]=1;this._uv[2]=1;this._uv[3]=1;this._uv[4]=0;this._uv[5]=0;this._uv[6]=1;this._uv[7]=0}function rt(n,t,i,r){this._x=n;this._y=t;this._width=i;this._height=r;this._proj_mat=null;this._view_mat=null;this._angle=0;this._left=!0;this._position_x=0;this._position_y=0;this._position_z=0}function ut(n,t){var i;for(this._img_array=n,this._num=n.length,this._gen_num=t,this._id=new Array(this._gen_num),r.genTextures(this._gen_num,this._id),this._gen=!0,this._use_id=new Array(this._gen_num),i=0;i<this._gen_num;i++)this._use_id[i]=!1;for(this._index2id=new Array(this._num),this._width=new Array(this._num),this._height=new Array(this._num),this._image_data=new Array(this._num),this._t_rgba=new Array(this._num),this._t_a=new Array(this._num),this._t_trans=new Array(this._num),this._t_alpha=new Array(this._num),this._tx=new Array(this._num),this._ty=new Array(this._num),this._apply_tx=new Array(this._num),this._apply_ty=new Array(this._num),i=0;i<this._num;i++)this._index2id[i]=-1,this._image_data[i]=null,this._t_rgba[i]=null,this._t_a[i]=null,this._tx[i]=0,this._ty[i]=0,this._apply_tx[i]=0,this._apply_ty[i]=0}function ft(n,t){var i,u;for(this._num=0,r.beginGetTriangle();r.getTriangle(n,t,!1);)this._num++;if(this._coord_x=null,this._coord_y=null,this._coord_z=null,this._normal_x=null,this._normal_y=null,this._normal_z=null,this._center_x=null,this._center_y=null,this._center_z=null,this._num>0){for(this._coord_x=new Array(this._num),this._coord_y=new Array(this._num),this._coord_z=new Array(this._num),i=0;i<this._num;i++)this._coord_x[i]=new Array(3),this._coord_y[i]=new Array(3),this._coord_z[i]=new Array(3);for(this._normal_x=new Array(this._num),this._normal_y=new Array(this._num),this._normal_z=new Array(this._num),this._center_x=new Array(this._num),this._center_y=new Array(this._num),this._center_z=new Array(this._num),u=0,r.beginGetTriangle();r.getTriangle(n,t,!1);){for(i=0;i<3;i++)this._coord_x[u][i]=r.coordX(i),this._coord_y[u][i]=r.coordY(i),this._coord_z[u][i]=r.coordZ(i);r.getTriangleNormal(n,t,!1);this._normal_x[u]=r.normalX();this._normal_y[u]=r.normalY();this._normal_z[u]=r.normalZ();this._center_x[u]=r.centerX();this._center_y[u]=r.centerY();this._center_z[u]=r.centerZ();u++}}}function w(){this.util_mat=new Array(16);this.look_mat=new Array(16);this.view_mat=new Array(16)}function b(){this.save=[];this.save_num=0;this.util_mat=new Array(16);this.tmp_mat=new Array(16);this._rotate=new Array(16);this._rotate[3]=0;this._rotate[7]=0;this._rotate[11]=0;this._rotate[12]=0;this._rotate[13]=0;this._rotate[14]=0;this._rotate[15]=1;this._scale=new Array(16);this._scale[0]=1;this._scale[1]=0;this._scale[2]=0;this._scale[3]=0;this._scale[4]=0;this._scale[5]=1;this._scale[6]=0;this._scale[7]=0;this._scale[8]=0;this._scale[9]=0;this._scale[10]=1;this._scale[11]=0;this._scale[12]=0;this._scale[13]=0;this._scale[14]=0;this._scale[15]=1;this._translate=new Array(16);this._translate[0]=1;this._translate[1]=0;this._translate[2]=0;this._translate[3]=0;this._translate[4]=0;this._translate[5]=1;this._translate[6]=0;this._translate[7]=0;this._translate[8]=0;this._translate[9]=0;this._translate[10]=1;this._translate[11]=0;this._translate[12]=0;this._translate[13]=0;this._translate[14]=0;this._translate[15]=1;this.trans_x=0;this.trans_y=0;this.trans_z=0;this.cross_x=0;this.cross_y=0;this.cross_z=0;this.normalize_x=0;this.normalize_y=0;this.normalize_z=0;this.reflect_x=0;this.reflect_y=0;this.reflect_z=0;this.seek_len=0;this.seek_vertex=new Array(3);this.coord_x=new Array(3);this.coord_y=new Array(3);this.coord_z=new Array(3);this.normal_x=0;this.normal_y=0;this.normal_z=0;this.center_x=0;this.center_y=0;this.center_z=0;this.hit_x=0;this.hit_y=0;this.hit_z=0;this.position_x=0;this.position_y=0;this.position_z=0;this.look_side=new Array(3);this.look_mat=new Array(16);this.view_mat=new Array(16);this.proj_mat=new Array(16);this.viewport_mat=new Array(4);this.project_in=new Array(4);this.project_out=new Array(4);this.project_x=0;this.project_y=0;this.project_z=0}var e=n.document,s="canvas",h="webgl",et="WEBGL_depth_texture",ot="OES_texture_float",a="2d",st="left",ht="bottom",ct="string",lt=",",k=".",at="0",vt="-",yt="-0",pt="attribute",wt="uniform",bt=";",d=" ",i,r,u,nt;o.prototype={draw:function(n,t){switch(this._p.type()){case 0:this._p.setTransparency(this._trans);this._p.draw(n,this._index,this._tex_index,t);break;case 1:this._p.setTransparency(this._trans);this._p.draw(n,this._tex_index,t)}}};g.prototype={clear:function(){for(var n=this._draw.length-1;n>=0;n--)this._draw[n]!=null&&(this._draw[n]=null);this._draw.length=0},add:function(n,t,i,r,u){if(n.type()==0&&t<0)for(var f=n.stripNum()-1;f>=0;f--)this._draw[this._draw.length]=new o(n,f,i,r,u,!1);else this._draw[this._draw.length]=new o(n,t,i,r,u,!1)},addSprite:function(n,t,i,u,f,e){var s=this._draw.length;return this._draw[s]=new o(n,-1,t,r.spriteMatrix(i,u,f,this._sprite_view_flag),e,!0,i,u,f),this._draw[s]._distance},addSpriteScale:function(n,t,i,u,f,e,s,h,c){var l=this._draw.length;return r.spriteMatrix(i,u,f,this._sprite_view_flag),r.scale(e,s,h),this._draw[l]=new o(n,-1,t,r.glMatrix(),c,!0,i,u,f),this._draw[l]._distance},draw:function(n){for(var e,s,r,u=this._draw.length,f=[],o=0,t=0;t<u;t++)this._draw[t]._distance==0&&(this._draw[t]._distance=-1,f[o++]=this._draw[t]);for(;o<u;o++){for(s=0,e=0,t=0;t<u;t++)this._draw[t]._distance>=s&&(s=this._draw[t]._distance,e=t);this._draw[e]._distance=-1;f[o]=this._draw[e]}for(t=0;t<u;t++)r=f[t],glDrawUseProgram(i,r._p,r._index),glDrawSetProjectionMatrix(i,this._proj_mat,r._p,r._index),glDrawSetModelViewMatrix(i,r._mat,r._p,r._index),r.draw(n,!1);for(t=0;t<u;t++)r=f[t],glDrawUseProgram(i,r._p,r._index),glDrawSetProjectionMatrix(i,this._proj_mat,r._p,r._index),glDrawSetModelViewMatrix(i,r._mat,r._p,r._index),r.draw(n,!0);for(t=0;t<u;t++)f[t]=null;f=null}};u=null;nt=function(){u!=null&&(getCurrentContext().clearRect(0,0,getWidth(),getHeight()),getCurrentContext().save(),clear2D(getGraphics()));paint3D(i,r);u!=null&&(paint2D(getGraphics()),getCurrentContext().restore())};p.prototype={type:function(){return this._glp.type()},depth:function(){return this._glp.depth()},setTransparency:function(n){this._glp.setTransparency(n)},transparency:function(){return this._glp.transparency()},id:function(){return this._id},lighting:function(){return this._lighting},setMaterial:function(n,t,i,r,u,f,e){this._material_num=n;this._material_texture=t;this._material_diffuse=i;this._material_ambient=r;this._material_emission=u;this._material_specular=f;this._material_shininess=e},setObject:function(n,t,i,r,u,f){this._object_num=n;this._coord=t;this._normal=i;this._color=r;this._map=u;this._radius=f},setStrip:function(n,i,r,u,f,e,o,s,h){h==t&&(h=2);this._strip_num=n;this._strip_material=i;this._strip_coord=r;this._strip_normal=u;this._strip_color=f;this._strip_map=e;this._strip_len=o;this._strip=s;this._strip_type=h},setStripTranslate:function(n,t,i){this._strip_tx=n;this._strip_ty=t;this._strip_tz=i},setStripRotate:function(n,t,i,r){this._strip_or=n;this._strip_ox=t;this._strip_oy=i;this._strip_oz=r},setTextureEnvMode:function(n){this._texture_env_mode_flag=!0;this._texture_env_mode=n},colorNum:function(){return this._color==null?0:this._color.length},setColor:function(n,t,i,r,u){for(var f=0;f<this._color[n].length/4;f++)this._color[n][f*4]=t,this._color[n][f*4+1]=i,this._color[n][f*4+2]=r,this._color[n][f*4+3]=u},stripNum:function(){return this._strip_num},stripTranslate:function(n){r.translate(this._strip_tx[n],this._strip_ty[n],this._strip_tz[n])},stripRotate:function(n){r.rotate(this._strip_or[n],this._strip_ox[n],this._strip_oy[n],this._strip_oz[n])},textureIndex:function(n){return this._strip_material[n]<0?-1:this._material_texture[this._strip_material[n]]},textureAlpha:function(n,t,i){var u=!1,r=this.depth();return i<0&&(i=this.textureIndex(t)),i>=0&&(n.use(i),n.setTransparency(i,this.transparency()),u=n.alpha(i),r&&(r=n.depth(i))),u&&!r},draw:function(n,t,r,u){var a=this.textureAlpha(n,t,r),e,y,o,f,v;if(this.transparency()!=1&&(a=!0),a==u){if(this._strip_coord[t]>=0&&(i.bindBuffer(i.ARRAY_BUFFER,this._position_buffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._coord[this._strip_coord[t]]),i.STATIC_DRAW),glModelBindPositionBuffer(i,this._id,this._lighting),i.bindBuffer(i.ARRAY_BUFFER,null)),this._normal!=null&&this._strip_normal[t]>=0&&(i.bindBuffer(i.ARRAY_BUFFER,this._normal_buffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._normal[this._strip_normal[t]]),i.STATIC_DRAW),glModelBindNormalBuffer(i,this._id,this._lighting),i.bindBuffer(i.ARRAY_BUFFER,null)),this._color!=null&&this._strip_color[t]>=0){if(y=this.transparency(),y!=1)for(o=this._color[this._strip_color[t]],e=new Array(o.length),f=0;f<o.length;f+=4)e[f]=o[f],e[f+1]=o[f+1],e[f+2]=o[f+2],e[f+3]=o[f+3]*y;else e=this._color[this._strip_color[t]];i.bindBuffer(i.ARRAY_BUFFER,this._color_buffer);i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.STATIC_DRAW);glModelBindColorBuffer(i,this._id,this._lighting);i.bindBuffer(i.ARRAY_BUFFER,null)}r<0&&(r=this.textureIndex(t));glModelSetTexture(i,n,t,r,this._id,this._lighting)||this._map!=null&&this._strip_map[t]>=0&&r>=0&&(i.activeTexture(glModelActiveTexture(i,this._id)),n.bindTexture(i.TEXTURE_2D,n.id(r)),i.bindBuffer(i.ARRAY_BUFFER,this._texture_coord_buffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._map[this._strip_map[t]]),i.STATIC_DRAW),glModelBindTextureCoordBuffer(i,this._id,this._lighting),i.bindBuffer(i.ARRAY_BUFFER,null));var s=null,h=null,c=null,l=null,p=null;this._material_diffuse!=null&&this._strip_material[t]>=0&&(s=new Array(4),s[0]=this._material_diffuse[this._strip_material[t]*4],s[1]=this._material_diffuse[this._strip_material[t]*4+1],s[2]=this._material_diffuse[this._strip_material[t]*4+2],s[3]=this._material_diffuse[this._strip_material[t]*4+3]);this._material_ambient!=null&&this._strip_material[t]>=0&&(h=new Array(4),h[0]=this._material_ambient[this._strip_material[t]*4],h[1]=this._material_ambient[this._strip_material[t]*4+1],h[2]=this._material_ambient[this._strip_material[t]*4+2],h[3]=this._material_ambient[this._strip_material[t]*4+3]);this._material_emission!=null&&this._strip_material[t]>=0&&(c=new Array(4),c[0]=this._material_emission[this._strip_material[t]*4],c[1]=this._material_emission[this._strip_material[t]*4+1],c[2]=this._material_emission[this._strip_material[t]*4+2],c[3]=this._material_emission[this._strip_material[t]*4+3]);this._material_specular!=null&&this._strip_material[t]>=0&&(l=new Array(4),l[0]=this._material_specular[this._strip_material[t]*4],l[1]=this._material_specular[this._strip_material[t]*4+1],l[2]=this._material_specular[this._strip_material[t]*4+2],l[3]=this._material_specular[this._strip_material[t]*4+3]);this._material_shininess!=null&&this._strip_material[t]>=0&&(p=this._material_shininess[this._strip_material[t]]);a&&(i.disable(i.CULL_FACE),i.enable(i.BLEND),i.depthMask(!1));glModelBeginDraw(i,n,t,r,this._id,this._lighting,s,h,c,l,p)&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._strip_buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(this._strip[t]),i.STATIC_DRAW),v=i.getBufferParameter(i.ELEMENT_ARRAY_BUFFER,i.BUFFER_SIZE)/2,this._strip_type==0?i.drawElements(i.LINE_STRIP,v,i.UNSIGNED_SHORT,0):this._strip_type==1?i.drawElements(i.LINES,v,i.UNSIGNED_SHORT,0):this._strip_type==2&&i.drawElements(i.TRIANGLE_STRIP,v,i.UNSIGNED_SHORT,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),glModelEndDraw(i,n,t,r,this._id,this._lighting));a&&(i.enable(i.CULL_FACE),i.disable(i.BLEND),i.depthMask(!0))}},radius:function(){return this._radius}};c.prototype={get:function(){if(typeof this._data==ct){for(var n="",t;(t=this._data.charAt(this._cur++))!=lt;)if(n+=t,this._cur>=this._data.length)break;return n.length>0?n.charAt(0)==k?Number(at+n):n.charAt(0)==vt&&n.length>1&&n.charAt(1)==k?Number(yt+n.substring(1)):Number(n):0}return this._data[this._cur++]}};l.prototype={setType:function(n){this._type=n},setDepth:function(n){this._depth=n},setTransparency:function(n){this._trans=n},type:function(){return this._type},depth:function(){return this._depth},transparency:function(){return this._trans}};f.prototype={attrib:function(n){return this.vars!=t?this.vars[n]:i.getAttribLocation(this._program,n)},uniform:function(n){return this.vars!=t?this.vars[n]:i.getUniformLocation(this._program,n)},use:function(){i.useProgram(this._program)}};f.bindPositionBuffer=function(n){i.vertexAttribPointer(n,3,i.FLOAT,!1,0,0);i.enableVertexAttribArray(n)};f.bindNormalBuffer=function(n){i.vertexAttribPointer(n,3,i.FLOAT,!1,0,0);i.enableVertexAttribArray(n)};f.bindColorBuffer=function(n){i.vertexAttribPointer(n,4,i.FLOAT,!1,0,0);i.enableVertexAttribArray(n)};f.bindTextureCoordBuffer=function(n){i.vertexAttribPointer(n,2,i.FLOAT,!1,0,0);i.enableVertexAttribArray(n)};f.setIndexBuffer=function(n,t){i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n);i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),i.STATIC_DRAW);i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null)};f.setArrayBuffer=function(n,t){i.bindBuffer(i.ARRAY_BUFFER,n);i.bufferData(i.ARRAY_BUFFER,new Float32Array(t),i.STATIC_DRAW);i.bindBuffer(i.ARRAY_BUFFER,null)};f.bindArrayBuffer=function(n,r,u,f){var e=f==t?u:f;i.bindBuffer(i.ARRAY_BUFFER,r);f!=t&&i.bufferData(i.ARRAY_BUFFER,new Float32Array(u),i.STATIC_DRAW);i.vertexAttribPointer(n,e,i.FLOAT,!1,0,0);i.enableVertexAttribArray(n);i.bindBuffer(i.ARRAY_BUFFER,null)};it.prototype={type:function(){return this._glp.type()},depth:function(){return this._glp.depth()},setTransparency:function(n){this._glp.setTransparency(n)},transparency:function(){return this._glp.transparency()},id:function(){return this._id},setCoord:function(n){for(var t=0;t<12;t++)this._coord[t]=n[t]},setMap:function(n,i){var r;if(i==t&&(i=!1),this._uv_f=i,this._uv_f)for(r=0;r<8;r++)this._uv[r]=n[r];else for(r=0;r<8;r++)this._map[r]=n[r]},textureAlpha:function(n,t){var i=!1,r=this.depth();return t>=0&&(n.use(t),n.setTransparency(t,this.transparency()),i=n.alpha(t)),i&&!r},draw:function(n,t,r){var f=this.textureAlpha(n,t),e,o,u;if(this.transparency()!=1&&(f=!0),f==r){if(i.bindBuffer(i.ARRAY_BUFFER,this._coord_buffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._coord),i.STATIC_DRAW),glSpriteBindPositionBuffer(i,this._id),i.bindBuffer(i.ARRAY_BUFFER,null),!this._uv_f)for(e=n.width(t),o=n.height(t),u=0;u<4;u++)this._uv[u*2]=this._map[u*2]/e,this._uv[u*2+1]=this._map[u*2+1]/o;i.bindBuffer(i.ARRAY_BUFFER,this._uv_buffer);i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._uv),i.STATIC_DRAW);glSpriteBindTextureCoordBuffer(i,this._id);i.bindBuffer(i.ARRAY_BUFFER,null);glSpriteSetTexture(i,n,t,this._id)||t>=0&&(i.activeTexture(glSpriteActiveTexture(i,this._id)),n.bindTexture(i.TEXTURE_2D,n.id(t)));f&&(i.disable(i.CULL_FACE),i.enable(i.BLEND),i.depthMask(!1));i.drawArrays(i.TRIANGLE_STRIP,0,4);f&&(i.enable(i.CULL_FACE),i.disable(i.BLEND),i.depthMask(!0))}}};rt.prototype={setProjectionMatrix:function(n){r.set(r.utMatrix(n));r.scale(2,1,1);this._proj_mat=r.glMatrix();glStereoSetProjectionMatrix(i,this._proj_mat)},projectionMatrix:function(){return this._proj_mat},setViewMatrix:function(n,t){this._view_mat=n;this._angle=t;this._position_x=r.positionX();this._position_y=r.positionY();this._position_z=r.positionZ()},clear:function(n){i.enable(i.SCISSOR_TEST);this._left?i.scissor(this._x,this._y,this._width/2,this._height):i.scissor(this._x+this._width/2,this._y,this._width/2,this._height);i.clear(n);i.disable(i.SCISSOR_TEST)},viewport:function(n,i,u,f){n==t&&(n=this._x);i==t&&(i=this._y);u==t&&(u=this._width);f==t&&(f=this._height);this._left?r.viewport(n,i,u/2,f):r.viewport(n+u/2,i,u/2,f)},draw:function(){this._view_mat!=null&&(r.set(r.utMatrix(this._view_mat)),r.rotate(-this._angle,0,1,0),glStereoSetViewMatrix(i,r.glMatrix()),r.setViewMatrix(),r.rotate(this._angle,0,1,0),r.translate(this._position_x,this._position_y,this._position_z),r.transpose(),r.setLookMatrix());this._left=!0;glStereoDraw(i,r,this._left);this._view_mat!=null&&(r.set(r.utMatrix(this._view_mat)),r.rotate(this._angle,0,1,0),glStereoSetViewMatrix(i,r.glMatrix()),r.setViewMatrix(),r.rotate(-this._angle,0,1,0),r.translate(this._position_x,this._position_y,this._position_z),r.transpose(),r.setLookMatrix());this._left=!1;glStereoDraw(i,r,this._left)},getGraphics:function(n){var r=this._width/2,i=getGraphics();return n!=t?this._left?(i.setOrigin(0,0),i.setClip(0,0,r,this._height)):n?(i.setOrigin(r,0),i.setClip(0,0,r,this._height)):(i.setOrigin(0,0),i.setClip(r,0,r,this._height)):(i.setOrigin(0,0),this._left?i.setClip(0,0,r,this._height):i.setClip(r,0,r,this._height)),i},draw2D:function(n){var t=this._width/2;n.setOrigin(0,0);n.setClip(0,0,t,this._height);glStereoDraw2D(n,t);n.setOrigin(t,0);n.setClip(0,0,t,this._height);glStereoDraw2D(n,t);n.setOrigin(0,0)}};ut.prototype={_SHIFTL:function(n){return n*16777216},_SHIFTR:function(n){return _DIV(n,16777216)},bindTexture:function(n,t){r.bindTexture(n,t)},dispose:function(){for(var n=0;n<this._num;n++)this.unuse(n);this._gen&&(r.deleteTextures(this._gen_num,this._id),this._gen=!1)},imageDataFromImage:function(n){var t=e.createElement(s),i=t.getContext(a);return t.width=n.width,t.height=n.height,i.drawImage(n,0,0),i.getImageData(0,0,t.width,t.height)},imageDataFromPixels:function(n,t,i){var r=e.createElement(s),p=r.getContext(a),v,u,f,l,y,o,h,c;for(r.width=t,r.height=i,v=p.getImageData(0,0,r.width,r.height),u=v.data,l=0;l<i;l++)for(y=l*t,h=y*4,f=0;f<t;f++)o=f*4,c=n[y+f],u[h+o]=this._SHIFTR(c)&255,u[h+o+1]=c>>16&255,u[h+o+2]=c>>8&255,u[h+o+3]=c&255;return v},getTextureSize:function(n){for(var t=1;;){if(t>=n)break;t*=2}return t},use:function(n,u){var f,o,e;if(!(this._index2id[n]>=0)){for(u==t&&(u=!1),this._index2id[n]=0,f=0;f<this._gen_num;f++)if(!this._use_id[f]){this._use_id[f]=!0;this._index2id[n]=f;break}if(this._image_data[n]=this.imageDataFromImage(this._img_array[n]),this._width[n]=this._image_data[n].width,this._height[n]=this._image_data[n].height,u)for(o=this._width[n]*this._height[n],this._t_rgba[n]=new Array(o),this._t_a[n]=new Array(o),e=this._image_data[n].data,f=0;f<o;f++)this._t_rgba[n][f]=this._SHIFTL(e[f*4])+(e[f*4+1]<<16)+(e[f*4+2]<<8)+e[f*4+3],this._t_a[n][f]=e[f*4+3];this._t_trans[n]=1;this._t_alpha[n]=glTextureAlphaFlag(n);r.bindTexture(this._id[this._index2id[n]]);i.pixelStorei(i.UNPACK_ALIGNMENT,1);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,glTextureFlipY(n));r.texImage2D(this._image_data[n]);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,glTextureFilter(i,n));i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,glTextureFilter(i,n));i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,glTextureWrap(i,n));i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,glTextureWrap(i,n))}},unuse:function(n){this._index2id[n]>=0&&(this._use_id[this._index2id[n]]=!1,this._image_data[n]=null,this._t_rgba[n]=null,this._t_a[n]=null,this._index2id[n]=-1)},unuseAll:function(){for(var n=0;n<this._num;n++)this.unuse(n);r.deleteTextures(this._gen_num,this._id);r.genTextures(this._gen_num,this._id)},update:function(n,t,u){var e,f;if(this._index2id[n]>=0&&(e=this._width[n]*this._height[n],u==e)){if(this._image_data[n]=this.imageDataFromPixels(t,this._width[n],this._height[n]),this._t_rgba[n]!=null&&this._t_a[n]!=null)for(_System.arraycopy(t,0,this._t_rgba[n],0,e),f=0;f<e;f++)this._t_a[n][f]=this._t_rgba[n][f]&255;this._t_trans[n]=1;this._t_alpha[n]=glTextureAlphaFlag(n);i.pixelStorei(i.UNPACK_ALIGNMENT,1);r.bindTexture(this._id[this._index2id[n]]);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,glTextureFlipY(n));r.texImage2D(this._image_data[n])}},setTransparency:function(n,t){var f,e,o,s,h,u;if(this._t_rgba[n]!=null&&this._t_a[n]!=null&&(this.use(n),t!=this._t_trans[n])){for(this._t_trans[n]=t,f=this._width[n]*this._height[n],u=0;u<f;u++)e=this._SHIFTR(this._t_rgba[n][u])&255,o=this._t_rgba[n][u]>>16&255,s=this._t_rgba[n][u]>>8&255,h=_INT(this._t_a[n][u]*this._t_trans[n]),this._t_rgba[n][u]=this._SHIFTL(e)+(o<<16)+(s<<8)+h;this._image_data[n]=this.imageDataFromPixels(this._t_rgba[n],this._width[n],this._height[n]);this._t_alpha[n]=this._t_trans[n]==1?glTextureAlphaFlag(n):!0;i.pixelStorei(i.UNPACK_ALIGNMENT,1);r.bindTexture(this._id[this._index2id[n]]);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,glTextureFlipY(n));r.texImage2D(this._image_data[n])}},translate:function(n,t,u){var o,l,a,e,c;this.use(n);o=this._width[n];l=this._height[n];this._tx[n]=t*o;this._ty[n]=u*l;var v=this._apply_tx[n]-_INT(this._tx[n]),y=this._apply_ty[n]-_INT(this._ty[n]),p=glTextureWrap(i,n)==i.REPEAT,f,h,s;if(v!=0)if(this._apply_tx[n]=_INT(this._tx[n]),this._t_rgba[n]!=null&&this._t_a[n]!=null)for(e=new Array(2),e[0]=new Array(o),e[1]=new Array(o),c=new Array(2),c[0]=this._t_rgba[n],c[1]=this._t_a[n],f=0;f<l;f++){for(a=f*o,h=0;h<o;h++)if(s=h-v,p){while(s<0)s+=o;while(s>=o)s-=o;e[0][h]=c[0][a+s];e[1][h]=c[1][a+s]}else s<0||s>=o?(e[0][h]=0,e[1][h]=0):(e[0][h]=c[0][a+s],e[1][h]=c[1][a+s]);_System.arraycopy(e[0],0,c[0],a,o);_System.arraycopy(e[1],0,c[1],a,o)}else for(e=new Array(o*4),c=this._image_data[n].data,f=0;f<l;f++){for(a=f*o,h=0;h<o;h++)if(s=h-v,p){while(s<0)s+=o;while(s>=o)s-=o;e[h*4]=c[(a+s)*4];e[h*4+1]=c[(a+s)*4+1];e[h*4+2]=c[(a+s)*4+2];e[h*4+3]=c[(a+s)*4+3]}else s<0||s>=o?(e[h*4]=0,e[h*4+1]=0,e[h*4+2]=0,e[h*4+3]=0):(e[h*4]=c[(a+s)*4],e[h*4+1]=c[(a+s)*4+1],e[h*4+2]=c[(a+s)*4+2],e[h*4+3]=c[(a+s)*4+3]);_System.arraycopy(e,0,c,a*4,o*4)}if(y!=0)if(this._apply_ty[n]=_INT(this._ty[n]),this._t_rgba[n]!=null&&this._t_a[n]!=null){for(e=new Array(2),e[0]=new Array(l),e[1]=new Array(l),f=0;f<l;f++)e[0][f]=new Array(o),e[1][f]=new Array(o);for(c=new Array(2),c[0]=this._t_rgba[n],c[1]=this._t_a[n],f=0;f<l;f++)if(s=f-y,p){while(s<0)s+=l;while(s>=l)s-=l;_System.arraycopy(c[0],s*o,e[0][f],0,o);_System.arraycopy(c[1],s*o,e[1][f],0,o)}else if(s<0||s>=o)for(h=0;h<o;h++)e[0][f][h]=0,e[1][f][h]=0;else _System.arraycopy(c[0],s*o,e[0][f],0,o),_System.arraycopy(c[1],s*o,e[1][f],0,o);for(f=0;f<l;f++)_System.arraycopy(e[0][f],0,c[0],f*o,o),_System.arraycopy(e[1][f],0,c[1],f*o,o)}else{for(e=new Array(l),f=0;f<l;f++)e[f]=new Array(o*4);for(c=this._image_data[n].data,f=0;f<l;f++)if(s=f-y,p){while(s<0)s+=l;while(s>=l)s-=l;_System.arraycopy(c,s*o*4,e[f],0,o*4)}else if(s<0||s>=o)for(h=0;h<o;h++)e[f][h*4]=0,e[f][h*4+1]=0,e[f][h*4+2]=0,e[f][h*4+3]=0;else _System.arraycopy(c,s*o*4,e[f],0,o*4);for(f=0;f<l;f++)_System.arraycopy(e[f],0,c,f*o*4,o*4)}(v!=0||y!=0)&&(this._t_rgba[n]!=null&&(this._image_data[n]=this.imageDataFromPixels(this._t_rgba[n],o,l)),i.pixelStorei(i.UNPACK_ALIGNMENT,1),r.bindTexture(this._id[this._index2id[n]]),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,glTextureFlipY(n)),r.texImage2D(this._image_data[n]))},id:function(n){return this._id[this._index2id[n]]},width:function(n){return this._width[n]},height:function(n){return this._height[n]},alpha:function(n){return this._t_alpha[n]},depth:function(n){return glTextureDepthFlag(n)}};ft.prototype={num:function(){return this._num},coord_x:function(n){return this._coord_x[n]},coord_y:function(n){return this._coord_y[n]},coord_z:function(n){return this._coord_z[n]},normal_x:function(n){return this._normal_x[n]},normal_y:function(n){return this._normal_y[n]},normal_z:function(n){return this._normal_z[n]},center_x:function(n){return this._center_x[n]},center_y:function(n){return this._center_y[n]},center_z:function(n){return this._center_z[n]},check:function(n,t,i,r,u,f,e){return this._center_x[n]>=t&&this._center_x[n]<=i&&this._center_y[n]>=r&&this._center_y[n]<=u&&this._center_z[n]>=f&&this._center_z[n]<=e?!0:!1},hitCheck:function(n,t,i,u,f,e,o){for(var s=0;s<this._num;s++)if(this._center_x[s]>=n-o&&this._center_x[s]<=n+o&&this._center_y[s]>=t-o&&this._center_y[s]<=t+o&&this._center_z[s]>=i-o&&this._center_z[s]<=i+o&&r.hitCheck(n,t,i,u,f,e,this._coord_x[s],this._coord_y[s],this._coord_z[s]))return s;return-1}};w.prototype={push:function(n){for(var t=0;t<16;t++)this.util_mat[t]=n.util_mat[t],this.look_mat[t]=n.look_mat[t],this.view_mat[t]=n.view_mat[t]},pop:function(n){for(var t=0;t<16;t++)n.util_mat[t]=this.util_mat[t],n.look_mat[t]=this.look_mat[t],n.view_mat[t]=this.view_mat[t]}};b.prototype={genTextures:function(n,t){for(var r=0;r<n;r++)t[r]=i.createTexture()},deleteTextures:function(n,t){for(var r=0;r<n;r++)i.deleteTexture(t[r])},bindTexture:function(n,r){r==t&&(r=n,n=i.TEXTURE_2D);i.bindTexture(n,r)},texImage2D:function(n,r){r==t&&(r=n,n=i.TEXTURE_2D);var u=i.RGBA,f=i.RGBA,e=i.UNSIGNED_BYTE;i.texImage2D(n,0,u,f,e,r)},deg2rad:function(n){return n*3.1415926535897931/180},rad2deg:function(n){return n*180/3.1415926535897931},glMatrix:function(){for(var i=new Float32Array(16),n,r,t=0;t<4;t++)for(r=t*4,n=0;n<4;n++)i[r+n]=this.util_mat[n*4+t];return i},utMatrix:function(n){for(var r=new Array(16),t,u,i=0;i<4;i++)for(u=i*4,t=0;t<4;t++)r[u+t]=n[t*4+i];return r},push:function(){this.save[this.save_num]==t&&(this.save[this.save_num]=new w);this.save[this.save_num].push(this);this.save_num++},pop:function(){this.save_num>0&&(this.save_num--,this.save[this.save_num].pop(this))},invert:function(){var n,t;if(this.tmp_mat[0]=this.util_mat[5]*this.util_mat[10]*this.util_mat[15]-this.util_mat[5]*this.util_mat[11]*this.util_mat[14]-this.util_mat[9]*this.util_mat[6]*this.util_mat[15]+this.util_mat[9]*this.util_mat[7]*this.util_mat[14]+this.util_mat[13]*this.util_mat[6]*this.util_mat[11]-this.util_mat[13]*this.util_mat[7]*this.util_mat[10],this.tmp_mat[4]=-this.util_mat[4]*this.util_mat[10]*this.util_mat[15]+this.util_mat[4]*this.util_mat[11]*this.util_mat[14]+this.util_mat[8]*this.util_mat[6]*this.util_mat[15]-this.util_mat[8]*this.util_mat[7]*this.util_mat[14]-this.util_mat[12]*this.util_mat[6]*this.util_mat[11]+this.util_mat[12]*this.util_mat[7]*this.util_mat[10],this.tmp_mat[8]=this.util_mat[4]*this.util_mat[9]*this.util_mat[15]-this.util_mat[4]*this.util_mat[11]*this.util_mat[13]-this.util_mat[8]*this.util_mat[5]*this.util_mat[15]+this.util_mat[8]*this.util_mat[7]*this.util_mat[13]+this.util_mat[12]*this.util_mat[5]*this.util_mat[11]-this.util_mat[12]*this.util_mat[7]*this.util_mat[9],this.tmp_mat[12]=-this.util_mat[4]*this.util_mat[9]*this.util_mat[14]+this.util_mat[4]*this.util_mat[10]*this.util_mat[13]+this.util_mat[8]*this.util_mat[5]*this.util_mat[14]-this.util_mat[8]*this.util_mat[6]*this.util_mat[13]-this.util_mat[12]*this.util_mat[5]*this.util_mat[10]+this.util_mat[12]*this.util_mat[6]*this.util_mat[9],this.tmp_mat[1]=-this.util_mat[1]*this.util_mat[10]*this.util_mat[15]+this.util_mat[1]*this.util_mat[11]*this.util_mat[14]+this.util_mat[9]*this.util_mat[2]*this.util_mat[15]-this.util_mat[9]*this.util_mat[3]*this.util_mat[14]-this.util_mat[13]*this.util_mat[2]*this.util_mat[11]+this.util_mat[13]*this.util_mat[3]*this.util_mat[10],this.tmp_mat[5]=this.util_mat[0]*this.util_mat[10]*this.util_mat[15]-this.util_mat[0]*this.util_mat[11]*this.util_mat[14]-this.util_mat[8]*this.util_mat[2]*this.util_mat[15]+this.util_mat[8]*this.util_mat[3]*this.util_mat[14]+this.util_mat[12]*this.util_mat[2]*this.util_mat[11]-this.util_mat[12]*this.util_mat[3]*this.util_mat[10],this.tmp_mat[9]=-this.util_mat[0]*this.util_mat[9]*this.util_mat[15]+this.util_mat[0]*this.util_mat[11]*this.util_mat[13]+this.util_mat[8]*this.util_mat[1]*this.util_mat[15]-this.util_mat[8]*this.util_mat[3]*this.util_mat[13]-this.util_mat[12]*this.util_mat[1]*this.util_mat[11]+this.util_mat[12]*this.util_mat[3]*this.util_mat[9],this.tmp_mat[13]=this.util_mat[0]*this.util_mat[9]*this.util_mat[14]-this.util_mat[0]*this.util_mat[10]*this.util_mat[13]-this.util_mat[8]*this.util_mat[1]*this.util_mat[14]+this.util_mat[8]*this.util_mat[2]*this.util_mat[13]+this.util_mat[12]*this.util_mat[1]*this.util_mat[10]-this.util_mat[12]*this.util_mat[2]*this.util_mat[9],this.tmp_mat[2]=this.util_mat[1]*this.util_mat[6]*this.util_mat[15]-this.util_mat[1]*this.util_mat[7]*this.util_mat[14]-this.util_mat[5]*this.util_mat[2]*this.util_mat[15]+this.util_mat[5]*this.util_mat[3]*this.util_mat[14]+this.util_mat[13]*this.util_mat[2]*this.util_mat[7]-this.util_mat[13]*this.util_mat[3]*this.util_mat[6],this.tmp_mat[6]=-this.util_mat[0]*this.util_mat[6]*this.util_mat[15]+this.util_mat[0]*this.util_mat[7]*this.util_mat[14]+this.util_mat[4]*this.util_mat[2]*this.util_mat[15]-this.util_mat[4]*this.util_mat[3]*this.util_mat[14]-this.util_mat[12]*this.util_mat[2]*this.util_mat[7]+this.util_mat[12]*this.util_mat[3]*this.util_mat[6],this.tmp_mat[10]=this.util_mat[0]*this.util_mat[5]*this.util_mat[15]-this.util_mat[0]*this.util_mat[7]*this.util_mat[13]-this.util_mat[4]*this.util_mat[1]*this.util_mat[15]+this.util_mat[4]*this.util_mat[3]*this.util_mat[13]+this.util_mat[12]*this.util_mat[1]*this.util_mat[7]-this.util_mat[12]*this.util_mat[3]*this.util_mat[5],this.tmp_mat[14]=-this.util_mat[0]*this.util_mat[5]*this.util_mat[14]+this.util_mat[0]*this.util_mat[6]*this.util_mat[13]+this.util_mat[4]*this.util_mat[1]*this.util_mat[14]-this.util_mat[4]*this.util_mat[2]*this.util_mat[13]-this.util_mat[12]*this.util_mat[1]*this.util_mat[6]+this.util_mat[12]*this.util_mat[2]*this.util_mat[5],this.tmp_mat[3]=-this.util_mat[1]*this.util_mat[6]*this.util_mat[11]+this.util_mat[1]*this.util_mat[7]*this.util_mat[10]+this.util_mat[5]*this.util_mat[2]*this.util_mat[11]-this.util_mat[5]*this.util_mat[3]*this.util_mat[10]-this.util_mat[9]*this.util_mat[2]*this.util_mat[7]+this.util_mat[9]*this.util_mat[3]*this.util_mat[6],this.tmp_mat[7]=this.util_mat[0]*this.util_mat[6]*this.util_mat[11]-this.util_mat[0]*this.util_mat[7]*this.util_mat[10]-this.util_mat[4]*this.util_mat[2]*this.util_mat[11]+this.util_mat[4]*this.util_mat[3]*this.util_mat[10]+this.util_mat[8]*this.util_mat[2]*this.util_mat[7]-this.util_mat[8]*this.util_mat[3]*this.util_mat[6],this.tmp_mat[11]=-this.util_mat[0]*this.util_mat[5]*this.util_mat[11]+this.util_mat[0]*this.util_mat[7]*this.util_mat[9]+this.util_mat[4]*this.util_mat[1]*this.util_mat[11]-this.util_mat[4]*this.util_mat[3]*this.util_mat[9]-this.util_mat[8]*this.util_mat[1]*this.util_mat[7]+this.util_mat[8]*this.util_mat[3]*this.util_mat[5],this.tmp_mat[15]=this.util_mat[0]*this.util_mat[5]*this.util_mat[10]-this.util_mat[0]*this.util_mat[6]*this.util_mat[9]-this.util_mat[4]*this.util_mat[1]*this.util_mat[10]+this.util_mat[4]*this.util_mat[2]*this.util_mat[9]+this.util_mat[8]*this.util_mat[1]*this.util_mat[6]-this.util_mat[8]*this.util_mat[2]*this.util_mat[5],n=this.util_mat[0]*this.tmp_mat[0]+this.util_mat[1]*this.tmp_mat[4]+this.util_mat[2]*this.tmp_mat[8]+this.util_mat[3]*this.tmp_mat[12],n==0)return!1;for(n=1/n,t=0;t<16;t++)this.util_mat[t]=this.tmp_mat[t]*n;return!0},multiply:function(n){for(var t,i,r=0;r<4;r++)for(i=r*4,t=0;t<4;t++)this.tmp_mat[i+t]=this.util_mat[i]*n[t]+this.util_mat[i+1]*n[4+t]+this.util_mat[i+2]*n[8+t]+this.util_mat[i+3]*n[12+t];this.set(this.tmp_mat)},rotate:function(n,t,i,r){var e=Math.sqrt(t*t+i*i+r*r);e!=0&&(t/=e,i/=e,r/=e);var s=this.deg2rad(n),o=Math.cos(s),f=Math.sin(s),u=1-o;this._rotate[0]=t*t*u+o;this._rotate[1]=t*i*u-r*f;this._rotate[2]=t*r*u+i*f;this._rotate[4]=i*t*u+r*f;this._rotate[5]=i*i*u+o;this._rotate[6]=i*r*u-t*f;this._rotate[8]=t*r*u-i*f;this._rotate[9]=i*r*u+t*f;this._rotate[10]=r*r*u+o;this.multiply(this._rotate)},scale:function(n,t,i){this._scale[0]=n;this._scale[5]=t;this._scale[10]=i;this.multiply(this._scale)},get:function(){for(var t=new Array(16),n=0;n<16;n++)t[n]=this.util_mat[n];return t},set:function(n){for(var t=0;t<16;t++)this.util_mat[t]=n[t]},setVal:function(n,t){this.util_mat[n]=t},setIdentity:function(){this.util_mat[0]=1;this.util_mat[1]=0;this.util_mat[2]=0;this.util_mat[3]=0;this.util_mat[4]=0;this.util_mat[5]=1;this.util_mat[6]=0;this.util_mat[7]=0;this.util_mat[8]=0;this.util_mat[9]=0;this.util_mat[10]=1;this.util_mat[11]=0;this.util_mat[12]=0;this.util_mat[13]=0;this.util_mat[14]=0;this.util_mat[15]=1},translate:function(n,t,i){this._translate[3]=n;this._translate[7]=t;this._translate[11]=i;this.multiply(this._translate)},transpose:function(){for(var n,i,t=0;t<4;t++)for(i=t*4,n=0;n<4;n++)this.tmp_mat[i+n]=this.util_mat[n*4+t];this.set(this.tmp_mat)},transVector:function(n,t,i){this.trans_x=this.util_mat[0]*n+this.util_mat[1]*t+this.util_mat[2]*i+this.util_mat[3]*1;this.trans_y=this.util_mat[4]*n+this.util_mat[5]*t+this.util_mat[6]*i+this.util_mat[7]*1;this.trans_z=this.util_mat[8]*n+this.util_mat[9]*t+this.util_mat[10]*i+this.util_mat[11]*1},cross:function(n,t,i,r,u,f){this.cross_x=t*f-i*u;this.cross_y=i*r-n*f;this.cross_z=n*u-t*r},dot:function(n,t,i,r,u,f){return n*r+t*u+i*f},distance:function(n,t,i){return Math.sqrt(n*n+t*t+i*i)},normalize:function(n,t,i){var r=Math.sqrt(n*n+t*t+i*i);r!=0?(this.normalize_x=n/r,this.normalize_y=t/r,this.normalize_z=i/r):(this.normalize_x=0,this.normalize_y=0,this.normalize_z=0)},reflect:function(n,t,i,r,u,f){var e=this.dot(-n,-t,-i,r,u,f),o=r*e,s=u*e,h=f*e;this.reflect_x=n+o+o;this.reflect_y=t+s+s;this.reflect_z=i+h+h},beginGetTriangle:function(){this.seek_len=2},getTriangle:function(n,t,i){for(var u=!1,r;this.seek_len<n._strip_len[t];){for(r=0;r<3;r++)this.seek_vertex[r]=n._strip[t][this.seek_len-r];if(this.seek_len++,this.seek_vertex[0]!=this.seek_vertex[1]&&this.seek_vertex[0]!=this.seek_vertex[2]&&this.seek_vertex[1]!=this.seek_vertex[2]){u=!0;break}}return u&&(this.getTriangleCoord(n,t,i),this.center_x=(this.coord_x[0]+this.coord_x[1]+this.coord_x[2])/3,this.center_y=(this.coord_y[0]+this.coord_y[1]+this.coord_y[2])/3,this.center_z=(this.coord_z[0]+this.coord_z[1]+this.coord_z[2])/3),u},getTriangleCoord:function(n,t,i){for(var r=0;r<3;r++)this.coord_x[r]=n._coord[n._strip_coord[t]][this.seek_vertex[r]*3],this.coord_y[r]=n._coord[n._strip_coord[t]][this.seek_vertex[r]*3+1],this.coord_z[r]=n._coord[n._strip_coord[t]][this.seek_vertex[r]*3+2];if(i)for(r=0;r<3;r++)this.transVector(this.coord_x[r],this.coord_y[r],this.coord_z[r]),this.coord_x[r]=this.trans_x,this.coord_y[r]=this.trans_y,this.coord_z[r]=this.trans_z},getTriangleNormal:function(n,t,i){var e;if(n._strip_normal[t]>=0){var r=0,u=0,f=0;for(e=0;e<3;e++)r+=n._normal[n._strip_normal[t]][this.seek_vertex[e]*3],u+=n._normal[n._strip_normal[t]][this.seek_vertex[e]*3+1],f+=n._normal[n._strip_normal[t]][this.seek_vertex[e]*3+2];i&&(this.transVector(r,u,f),r=this.trans_x,u=this.trans_y,f=this.trans_z);this.cross(this.coord_x[1]-this.coord_x[0],this.coord_y[1]-this.coord_y[0],this.coord_z[1]-this.coord_z[0],this.coord_x[2]-this.coord_x[0],this.coord_y[2]-this.coord_y[0],this.coord_z[2]-this.coord_z[0]);this.cross_x=Math.abs(this.cross_x);this.cross_y=Math.abs(this.cross_y);this.cross_z=Math.abs(this.cross_z);(this.cross_x<1||this.cross_y<1||this.cross_z<1)&&(r=r<0?-this.cross_x:this.cross_x,u=u<0?-this.cross_y:this.cross_y,f=f<0?-this.cross_z:this.cross_z);this.normalize(r,u,f);this.normal_x=this.normalize_x;this.normal_y=this.normalize_y;this.normal_z=this.normalize_z}},checkTriangle:function(n,t,i,r,u,f){return this.center_x>=n&&this.center_x<=t&&this.center_y>=i&&this.center_y<=r&&this.center_z>=u&&this.center_z<=f?!0:!1},hitCheck:function(n,t,i,r,u,f,e,o,s){var c,h;this.cross(e[1]-e[0],o[1]-o[0],s[1]-s[0],e[2]-e[0],o[2]-o[0],s[2]-s[0]);var l=this.cross_x,a=this.cross_y,v=this.cross_z,y=r-n,p=u-t,w=f-i,k=l*(e[0]-n)+a*(o[0]-t)+v*(s[0]-i),b=this.dot(l,a,v,y,p,w);if(b==0||(c=k/b,c<0||c>1))return!1;for(this.hit_x=n+c*y,this.hit_y=t+c*p,this.hit_z=i+c*w,h=0;h<3;h++)if(this.cross(e[h==2?0:h+1]-e[h],o[h==2?0:h+1]-o[h],s[h==2?0:h+1]-s[h],this.hit_x-e[h],this.hit_y-o[h],this.hit_z-s[h]),this.cross_x*l<-1||this.cross_y*a<-1||this.cross_z*v<-1)return!1;return!0},lookAt:function(n,t,i,r,u,f,e,o,s){var h,c,l,a;for(this.position_x=n,this.position_y=t,this.position_z=i,r-=this.position_x,u-=this.position_y,f-=this.position_z,h=Math.sqrt(r*r+u*u+f*f),h!=0&&(r/=h,u/=h,f/=h),this.look_side[0]=u*s-f*o,this.look_side[1]=f*e-r*s,this.look_side[2]=r*o-u*e,h=Math.sqrt(this.look_side[0]*this.look_side[0]+this.look_side[1]*this.look_side[1]+this.look_side[2]*this.look_side[2]),h!=0&&(this.look_side[0]/=h,this.look_side[1]/=h,this.look_side[2]/=h),e=this.look_side[1]*f-this.look_side[2]*u,o=this.look_side[2]*r-this.look_side[0]*f,s=this.look_side[0]*u-this.look_side[1]*r,this.look_mat[0]=this.look_side[0],this.look_mat[1]=e,this.look_mat[2]=-r,this.look_mat[3]=0,this.look_mat[4]=this.look_side[1],this.look_mat[5]=o,this.look_mat[6]=-u,this.look_mat[7]=0,this.look_mat[8]=this.look_side[2],this.look_mat[9]=s,this.look_mat[10]=-f,this.look_mat[11]=0,this.look_mat[12]=0,this.look_mat[13]=0,this.look_mat[14]=0,this.look_mat[15]=1,l=0;l<4;l++)for(a=l*4,c=0;c<4;c++)this.view_mat[a+c]=this.look_mat[c*4+l];for(this.set(this.view_mat),this.translate(-this.position_x,-this.position_y,-this.position_z),c=0;c<16;c++)this.view_mat[c]=this.util_mat[c]},viewMatrix:function(){for(var t=new Array(16),n=0;n<16;n++)t[n]=this.view_mat[n];return t},lookMatrix:function(){for(var t=new Array(16),n=0;n<16;n++)t[n]=this.look_mat[n];return t},setViewMatrix:function(n){(n==null||n==t)&&(n=this.util_mat);for(var i=0;i<16;i++)this.view_mat[i]=n[i]},setLookMatrix:function(n){(n==null||n==t)&&(n=this.util_mat);for(var i=0;i<16;i++)this.look_mat[i]=n[i]},spriteMatrix:function(n,i,r,u){return u==t&&(u=!0),u?this.set(this.view_mat):this.setIdentity(),this.translate(n,i,r),this.multiply(this.look_mat),this.glMatrix()},frustum:function(n,t,i,r,u,f){this.proj_mat[0]=2*u/(t-n);this.proj_mat[1]=0;this.proj_mat[2]=(t+n)/(t-n);this.proj_mat[3]=0;this.proj_mat[4]=0;this.proj_mat[5]=2*u/(r-i);this.proj_mat[6]=(r+i)/(r-i);this.proj_mat[7]=0;this.proj_mat[8]=0;this.proj_mat[9]=0;this.proj_mat[10]=-(f+u)/(f-u);this.proj_mat[11]=-(2*f*u)/(f-u);this.proj_mat[12]=0;this.proj_mat[13]=0;this.proj_mat[14]=-1;this.proj_mat[15]=0;this.multiply(this.proj_mat);for(var e=0;e<16;e++)this.proj_mat[e]=this.util_mat[e]},ortho:function(n,t,i,r,u,f){this.proj_mat[0]=2/(t-n);this.proj_mat[1]=0;this.proj_mat[2]=0;this.proj_mat[3]=-(t+n)/(t-n);this.proj_mat[4]=0;this.proj_mat[5]=2/(r-i);this.proj_mat[6]=0;this.proj_mat[7]=-(r+i)/(r-i);this.proj_mat[8]=0;this.proj_mat[9]=0;this.proj_mat[10]=-2/(f-u);this.proj_mat[11]=-(f+u)/(f-u);this.proj_mat[12]=0;this.proj_mat[13]=0;this.proj_mat[14]=0;this.proj_mat[15]=1;this.multiply(this.proj_mat);for(var e=0;e<16;e++)this.proj_mat[e]=this.util_mat[e]},perspective:function(n,t,i,r){var f=1/Math.tan(n*Math.PI/360),u;for(this.proj_mat[0]=f/t,this.proj_mat[1]=0,this.proj_mat[2]=0,this.proj_mat[3]=0,this.proj_mat[4]=0,this.proj_mat[5]=f,this.proj_mat[6]=0,this.proj_mat[7]=0,this.proj_mat[8]=0,this.proj_mat[9]=0,this.proj_mat[10]=(r+i)/(i-r),this.proj_mat[11]=2*r*i/(i-r),this.proj_mat[12]=0,this.proj_mat[13]=0,this.proj_mat[14]=-1,this.proj_mat[15]=0,this.multiply(this.proj_mat),u=0;u<16;u++)this.proj_mat[u]=this.util_mat[u]},setProjMatrix:function(n){for(var t=0;t<16;t++)this.proj_mat[t]=n[t]},viewport:function(n,t,r,u){i.viewport(n,t,r,u);this.viewport_mat[0]=n;this.viewport_mat[1]=t;this.viewport_mat[2]=r;this.viewport_mat[3]=u},project:function(n,i,r,u,f){return((u==null||u==t)&&(u=this.view_mat),(f==null||f==t)&&(f=this.proj_mat),this.project_in[0]=n*u[0]+i*u[1]+r*u[2]+u[3],this.project_in[1]=n*u[4]+i*u[5]+r*u[6]+u[7],this.project_in[2]=n*u[8]+i*u[9]+r*u[10]+u[11],this.project_in[3]=n*u[12]+i*u[13]+r*u[14]+u[15],this.project_out[0]=this.project_in[0]*f[0]+this.project_in[1]*f[1]+this.project_in[2]*f[2]+this.project_in[3]*f[3],this.project_out[1]=this.project_in[0]*f[4]+this.project_in[1]*f[5]+this.project_in[2]*f[6]+this.project_in[3]*f[7],this.project_out[2]=this.project_in[0]*f[8]+this.project_in[1]*f[9]+this.project_in[2]*f[10]+this.project_in[3]*f[11],this.project_out[3]=this.project_in[0]*f[12]+this.project_in[1]*f[13]+this.project_in[2]*f[14]+this.project_in[3]*f[15],this.project_out[3]==0)?!1:(this.project_x=(this.project_out[0]/this.project_out[3]+1)/2*this.viewport_mat[2]+this.viewport_mat[0],this.project_y=(this.project_out[1]/this.project_out[3]+1)/2*this.viewport_mat[3]+this.viewport_mat[1],this.project_z=(this.project_out[2]/this.project_out[3]+1)/2,!0)},unProject:function(n,i,r,u,f){return((u==null||u==t)&&(u=this.view_mat),(f==null||f==t)&&(f=this.proj_mat),this.set(f),this.multiply(u),this.invert(),this.project_in[0]=(n-this.viewport_mat[0])*2/this.viewport_mat[2]-1,this.project_in[1]=(i-this.viewport_mat[1])*2/this.viewport_mat[3]-1,this.project_in[2]=r*2-1,this.project_out[0]=this.project_in[0]*this.util_mat[0]+this.project_in[1]*this.util_mat[1]+this.project_in[2]*this.util_mat[2]+this.util_mat[3],this.project_out[1]=this.project_in[0]*this.util_mat[4]+this.project_in[1]*this.util_mat[5]+this.project_in[2]*this.util_mat[6]+this.util_mat[7],this.project_out[2]=this.project_in[0]*this.util_mat[8]+this.project_in[1]*this.util_mat[9]+this.project_in[2]*this.util_mat[10]+this.util_mat[11],this.project_out[3]=this.project_in[0]*this.util_mat[12]+this.project_in[1]*this.util_mat[13]+this.project_in[2]*this.util_mat[14]+this.util_mat[15],this.project_out[3]==0)?!1:(this.project_x=this.project_out[0]/this.project_out[3],this.project_y=this.project_out[1]/this.project_out[3],this.project_z=this.project_out[2]/this.project_out[3],!0)},transX:function(){return this.trans_x},transY:function(){return this.trans_y},transZ:function(){return this.trans_z},crossX:function(){return this.cross_x},crossY:function(){return this.cross_y},crossZ:function(){return this.cross_z},normalizeX:function(){return this.normalize_x},normalizeY:function(){return this.normalize_y},normalizeZ:function(){return this.normalize_z},reflectX:function(){return this.reflect_x},reflectY:function(){return this.reflect_y},reflectZ:function(){return this.reflect_z},coordX:function(n){return this.coord_x[n]},coordY:function(n){return this.coord_y[n]},coordZ:function(n){return this.coord_z[n]},normalX:function(){return this.normal_x},normalY:function(){return this.normal_y},normalZ:function(){return this.normal_z},centerX:function(){return this.center_x},centerY:function(){return this.center_y},centerZ:function(){return this.center_z},hitX:function(){return this.hit_x},hitY:function(){return this.hit_y},hitZ:function(){return this.hit_z},positionX:function(){return this.position_x},positionY:function(){return this.position_y},positionZ:function(){return this.position_z},projectX:function(){return this.project_x},projectY:function(){return this.project_y},projectZ:function(){return this.project_z}};n._GLDrawPrimitive=o;n._GLDraw=g;n.canUseWebGL=kt;n.canUseWebGLDepthTexture=dt;n.canUseWebGLTextureFloat=gt;n.setCurrent3D=ni;n.getCurrent3D=v;n.getCurrentContext3D=ti;n.setCanvas3DSize=ii;n.createShaderProgram=y;n._GLModel=p;n._GLModelData=c;n.createGLModel=ri;n._GLPrimitive=l;n._GLShader=f;n._GLSprite=it;n._GLStereo=rt;n._GLTexture=ut;n._GLTriangle=ft;n._GLUtilitySave=w;n._GLUtility=b;n._GLPRIMITIVE_TYPE_MODEL=0;n._GLPRIMITIVE_TYPE_SPRITE=1;n._GLSTRIP_TYPE_LINE_STRIP=0;n._GLSTRIP_TYPE_LINES=1;n._GLSTRIP_TYPE_TRIANGLE_STRIP=2;n._GLSHADER_ERROR_COMPILE=0;n._GLSHADER_ERROR_LINK=1})(window)